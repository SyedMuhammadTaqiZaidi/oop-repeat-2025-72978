@model WorkshopSystem.Web.ViewModels.ServiceRecordCreateViewModel
@{
    ViewData["Title"] = "Create Service Record";
    var customers = ViewBag.Customers as IEnumerable<WorkshopSystem.Core.Application.DTOs.UserDto>;
    var mechanics = ViewBag.Mechanics as IEnumerable<WorkshopSystem.Core.Application.DTOs.UserDto>;
    var isAdmin = User.IsInRole("Admin");
}
<h1>Create Service Record</h1>

@if (ViewBag.CustomersCount != null)
{
    <div class="alert alert-info">
        <strong>Debug Info:</strong> 
        Customers: @ViewBag.CustomersCount, 
        Mechanics: @ViewBag.MechanicsCount
    </div>
}
<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()
    <div class="form-group">
        <label asp-for="CustomerId">Customer</label>
        <select asp-for="CustomerId" class="form-control" id="customerDropdown">
            <option value="">-- Select Customer --</option>
            @if (customers != null)
            {
                foreach (var customer in customers)
                {
                    <option value="@customer.Id">@customer.Email</option>
                }
            }
        </select>
        <span asp-validation-for="CustomerId" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="CarId">Car</label>
        <select asp-for="CarId" class="form-control" id="carDropdown">
            <option value="">-- Select Car --</option>
        </select>
        <span asp-validation-for="CarId" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="MechanicId">Mechanic</label>
        <select asp-for="MechanicId" class="form-control">
            <option value="">-- Select Mechanic --</option>
            @if (mechanics != null)
            {
                foreach (var mechanic in mechanics)
                {
                    <option value="@mechanic.Id">@mechanic.Email</option>
                }
            }
        </select>
        <span asp-validation-for="MechanicId" class="text-danger"></span>
    </div>
    @if (!isAdmin)
    {
        <div class="form-group">
            <label asp-for="Description">Description</label>
            <textarea asp-for="Description" class="form-control"></textarea>
            <span asp-validation-for="Description" class="text-danger"></span>
        </div>
        <div class="form-group">
            <label asp-for="HoursWorked">Hours Worked</label>
            <input asp-for="HoursWorked" class="form-control" type="number" step="0.5" min="0" id="hoursInput" />
            <span asp-validation-for="HoursWorked" class="text-danger"></span>
            <small class="form-text text-muted">Cost will be calculated automatically: €75 per hour</small>
        </div>

        <div class="form-group">
            <label>Calculated Cost</label>
            <input type="text" class="form-control" id="costDisplay" value="€0.00" readonly />
            <small class="form-text text-muted">This cost will be calculated based on hours worked</small>
        </div>
    }
    else
    {
        <input type="hidden" asp-for="Description" value="" />
        <input type="hidden" asp-for="HoursWorked" value="0" />
    }
    <button type="submit" class="btn btn-primary">Create</button>
    <a asp-action="Index" class="btn btn-secondary">Back to List</a>
</form>
@section Scripts {
    <script>
        $(document).ready(function () {
            // Customer dropdown change handler
            $('#customerDropdown').change(function () {
                var customerId = $(this).val();
                var carDropdown = $('#carDropdown');
                carDropdown.empty();
                carDropdown.append($('<option>', { value: '', text: '-- Select Car --' }));
                if (customerId) {
                    $.getJSON('/Cars/GetCarsByCustomer', { customerId: customerId }, function (cars) {
                        $.each(cars, function (i, car) {
                            carDropdown.append($('<option>', { value: car.id, text: car.registrationNumber }));
                        });
                    });
                }
            });

            // Hours input change handler for cost calculation
            $('#hoursInput').on('input', function() {
                var hours = parseFloat($(this).val()) || 0;
                var cost = Math.ceil(hours) * 75; // €75 per hour, rounded up
                $('#costDisplay').val('€' + cost.toFixed(2));
            });
        });
    </script>
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
